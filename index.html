<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Calendar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(to right, #097fd9, #d91d09);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .header h1 .red-text {
            color: #d91d09;
        }
        
        .header h2 {
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .target-animated, .bell-animated, .barber-pole-animated, .razor-animated {
            font-size: 2rem;
            position: absolute;
        }

        .target-animated {
            bottom: 10px;
            animation: target-move 4s ease-in-out infinite;
        }

        @keyframes target-move {
            0% {
                transform: translateX(-100px);
                opacity: 0;
            }
            50% {
                transform: translateX(0);
                opacity: 1;
            }
            100% {
                transform: translateX(100px);
                opacity: 0;
            }
        }

        @keyframes bell-ring {
            0% { transform: rotate(0); }
            15% { transform: rotate(15deg); }
            30% { transform: rotate(-15deg); }
            45% { transform: rotate(15deg); }
            60% { transform: rotate(-15deg); }
            75% { transform: rotate(0); }
            100% { transform: rotate(0); }
        }

        @keyframes barber-pole-spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes razor-shave {
            0%, 100% { transform: translateX(0) rotate(-15deg); }
            50% { transform: translateX(-10px) rotate(5deg); }
        }

        @keyframes zoom-in-out {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.5);
            }
        }

        .bell-ring-animation {
            animation: bell-ring 1s ease-in-out;
        }

        .barber-pole-animated {
            left: 20%;
            top: 10px;
            animation: barber-pole-spin 2s linear infinite, zoom-in-out 3s ease-in-out infinite;
        }

        .razor-animated {
            right: 20%;
            top: 10px;
            animation: razor-shave 1s ease-in-out infinite, zoom-in-out 3s ease-in-out infinite;
            transform-origin: 50% 50%;
        }

        .btn-custom {
            background: linear-gradient(to right, #d91d09, #097fd9);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            transition: background 0.3s ease;
        }

        .btn-custom:hover {
            background: linear-gradient(to right, #b81c08, #0762a4);
        }

        .month-nav-btn {
            background: #d91d09;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        .month-nav-btn:hover {
            background-color: #b81c08;
        }

        .lock-btn {
            background: none;
            border: none;
            color: black;
            font-size: 2rem;
            font-weight: bold;
            transition: color 0.3s;
            cursor: pointer;
        }

        .lock-btn:hover {
            color: #d91d09;
        }
        
        /* New custom modal and backdrop styles for robust functionality */
        .custom-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2001; /* Must be higher than backdrop */
            pointer-events: none; /* Initially non-clickable */
        }
        .custom-modal.open {
            pointer-events: auto;
        }
        .custom-modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 2002;
        }
        .custom-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000; /* Must be behind the modal */
        }

        .hidden {
            display: none !important;
        }
        .bg-blue-appointment {
            background-color: #9de3eb;
        }
        .bg-green-task {
            background-color: #47edcc;
        }
        .blocked-day {
            background-color: #ffcccc;
            color: #888;
        }
        .past-day {
            background-color: #e0e0e0;
            color: #a0a0a0;
            cursor: not-allowed;
        }
        .scrollable-content-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 8px;
        }

        .footer {
            background: linear-gradient(to right, #d91d09 60%, #097fd9);
            height: 50px;
            width: 100%;
            position: relative;
        }

        .calendar-container-wrapper {
            position: relative;
            display: flex;
            width: 100%;
            max-width: 1000px;
            margin: 0 auto;
        }

        .calendar-frame {
            position: absolute;
            height: 100%;
            width: 10px;
            background: linear-gradient(to bottom, #d91d09, #097fd9);
        }

        .calendar-frame-left {
            left: 0;
        }

        .calendar-frame-right {
            right: 0;
        }
        .appointment-completed {
            background-color: #a8f0a8;
        }
    </style>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, setDoc, deleteDoc, getDoc, getDocs, query, where, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('debug');

        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB0b-ojel3D_gsVg7dqv44BD0rVpacHhW0",
            authDomain: "express-capital-webhook.firebaseapp.com",
            projectId: "express-capital-webhook",
            storageBucket: "express-capital-webhook.firebasestorage.app",
            messagingSenderId: "163338622500",
            appId: "1:163338622500:web:f62cd0a2379ff45e03aab1",
            measurementId: "G-RF71N8KHB7"
        };
        
        const __app_id = "default-app-id";
        const __initial_auth_token = undefined;

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userId = null;
        let isAuthReady = false;

        const calendarEl = document.getElementById('calendar');
        const currentMonthYearEl = document.getElementById('currentMonthYear');
        const prevMonthBtn = document.getElementById('prevMonth');
        const nextMonthBtn = document.getElementById('nextMonth');
        const appointmentModal = document.getElementById('appointmentModal');
        const eventModal = document.getElementById('eventModal');
        const taskModal = document.getElementById('taskModal');
        const savedItemsModal = document.getElementById('savedItemsModal');
        const appointmentPurposeEl = document.getElementById('appointmentPurpose');
        const eventTypeEl = document.getElementById('eventType');
        const otherEventContainer = document.getElementById('otherEventContainer');
        const otherTaskContainer = document.getElementById('otherTaskContainer');
        const taskTypeEl = document.getElementById('taskType');
        const eventTimeEl = document.getElementById('eventTime');
        const eventCommentsEl = document.getElementById('eventComments');
        const savedItemsList = document.getElementById('savedItemsList');
        const viewAppointmentsBtn = document.getElementById('viewAppointmentsBtn');
        const viewEventsBtn = document.getElementById('viewEventsBtn');
        const blockBtn = document.getElementById('blockBtn');
        const unblockBtn = document.getElementById('unblockBtn');
        const blockModal = document.getElementById('blockModal');
        const unblockModal = document.getElementById('unblockModal');
        const blockDateSelector = document.getElementById('blockDateSelector');
        const blockFullDayBtn = document.getElementById('blockFullDayBtn');
        const blockStartTimeEl = document.getElementById('blockStartTime');
        const blockEndTimeEl = document.getElementById('blockEndTime');
        const saveBlockBtn = document.getElementById('saveBlockBtn');
        const unblockDateSelector = document.getElementById('unblockDateSelector');
        const showBlockedTimesBtn = document.getElementById('showBlockedTimesBtn');
        const unblockTimesList = document.getElementById('unblockTimesList');
        const bellEmojiEl = document.getElementById('bell-emoji');
        const adminLoginBtn = document.getElementById('adminLoginBtn');
        const exitAdminBtn = document.getElementById('exitAdminBtn');
        const adminButtons = document.querySelectorAll('.admin-button');
        const customAlertModal = document.getElementById('customAlertModal');
        const customAlertMessage = document.getElementById('customAlertMessage');
        const customAlertCloseBtn = document.getElementById('customAlertCloseBtn');

        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let selectedDate = null;
        let savedEvents = [];
        let savedTasks = [];
        let blockedTimes = [];
        let savedAppointments = [];
        let notifiedTasks = {};

        // Function to show a custom alert modal
        function showCustomAlert(message) {
            customAlertMessage.textContent = message;
            openModal('customAlertModal');
        }

        // Function to show a custom confirmation modal
        function showCustomConfirm(message, onConfirm) {
            document.getElementById('customConfirmMessage').textContent = message;
            document.getElementById('customConfirmConfirmBtn').onclick = () => {
                onConfirm();
                closeModal('customConfirmModal');
            };
            openModal('customConfirmModal');
        }

        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                const backdrop = document.createElement('div');
                backdrop.className = 'custom-backdrop';
                backdrop.id = 'modalBackdrop';
                document.body.appendChild(backdrop);
                modal.classList.remove('hidden');
                modal.classList.add('open');
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            const backdrop = document.getElementById('modalBackdrop');
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('open');
            }
            if (backdrop) {
                backdrop.remove();
            }
        }

        // New event listeners to handle closing modals when the backdrop is clicked
        document.addEventListener('click', function(e) {
            if (e.target.id === 'modalBackdrop') {
                const openModals = document.querySelectorAll('.custom-modal.open');
                openModals.forEach(modal => {
                    closeModal(modal.id);
                });
            }
        });

        // Event listener for the custom alert close button
        if (customAlertCloseBtn) {
            customAlertCloseBtn.addEventListener('click', () => closeModal('customAlertModal'));
        }

        // Event listener for the custom confirm close button
        if (document.getElementById('customConfirmCancelBtn')) {
            document.getElementById('customConfirmCancelBtn').addEventListener('click', () => closeModal('customConfirmModal'));
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
            } else {
                userId = crypto.randomUUID(); // Fallback for anonymous user
            }
            isAuthReady = true;
            document.getElementById('userIdDisplay').textContent = `User ID: ${userId}`;
            // Set up real-time listeners for all collections
            onSnapshot(collection(db, `/artifacts/${__app_id}/users/${userId}/appointments`), (snapshot) => {
                savedAppointments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                generateCalendar(currentMonth, currentYear);
            });
            onSnapshot(collection(db, `/artifacts/${__app_id}/users/${userId}/events`), (snapshot) => {
                savedEvents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                generateCalendar(currentMonth, currentYear);
            });
            onSnapshot(collection(db, `/artifacts/${__app_id}/users/${userId}/tasks`), (snapshot) => {
                savedTasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                generateCalendar(currentMonth, currentYear);
            });
            onSnapshot(collection(db, `/artifacts/${__app_id}/users/${userId}/blocked`), (snapshot) => {
                blockedTimes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                generateCalendar(currentMonth, currentYear);
            });
        });

        function getDaysInMonth(month, year) {
            return new Date(year, month + 1, 0).getDate();
        }

        function getFirstDayOfMonth(month, year) {
            return new Date(year, month, 1).getDay();
        }

        function generateCalendar(month, year) {
            const daysInMonth = getDaysInMonth(month, year);
            const firstDay = getFirstDayOfMonth(month, year);

            currentMonthYearEl.textContent = new Date(year, month).toLocaleString('default', { month: 'long', year: 'numeric' });

            calendarEl.innerHTML = '';
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayNames.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.textContent = day;
                dayHeader.className = 'font-bold text-gray-700';
                calendarEl.appendChild(dayHeader);
            });

            for (let i = 0; i < firstDay; i++) {
                const emptyDay = document.createElement('div');
                calendarEl.appendChild(emptyDay);
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dayEl = document.createElement('div');
                const currentDate = new Date(year, month, day);
                dayEl.textContent = day;
                dayEl.className = 'p-2 border rounded-md cursor-pointer transition-colors';

                if (isBlocked(currentDate)) {
                    dayEl.classList.add('blocked-day');
                } else if (isPastDate(currentDate)) {
                    dayEl.classList.add('past-day');
                    dayEl.style.cursor = 'not-allowed';
                } else {
                    dayEl.classList.add('hover:bg-gray-200');
                    dayEl.addEventListener('click', () => selectDay(currentDate));
                }
                
                if (hasItem(currentDate)) {
                    dayEl.classList.add('bg-blue-300');
                }

                calendarEl.appendChild(dayEl);
            }
        }

        function isBlocked(date) {
            return blockedTimes.some(b => {
                const blockedDate = new Date(b.date);
                return blockedDate.getFullYear() === date.getFullYear() &&
                       blockedDate.getMonth() === date.getMonth() &&
                       blockedDate.getDate() === date.getDate();
            });
        }

        function hasItem(date) {
            return savedAppointments.some(a => {
                const apptDate = new Date(a.date);
                return apptDate.getFullYear() === date.getFullYear() &&
                       apptDate.getMonth() === date.getMonth() &&
                       apptDate.getDate() === date.getDate();
            }) || savedEvents.some(e => {
                const eventDate = new Date(e.date);
                return eventDate.getFullYear() === date.getFullYear() &&
                       eventDate.getMonth() === date.getMonth() &&
                       eventDate.getDate() === date.getDate();
            }) || savedTasks.some(t => {
                const taskDate = new Date(t.date);
                return taskDate.getFullYear() === date.getFullYear() &&
                       taskDate.getMonth() === date.getMonth() &&
                       taskDate.getDate() === date.getDate();
            });
        }

        function isPastDate(date) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            return date < today;
        }

        function selectDay(date) {
            if (isPastDate(date) || isBlocked(date)) {
                return;
            }
            selectedDate = date;
            openModal('mainModal');
        }

        document.getElementById('saveAppointmentBtn').addEventListener('click', () => saveItem('appointment'));
        document.getElementById('saveEventBtn').addEventListener('click', () => saveItem('event'));
        document.getElementById('saveTaskBtn').addEventListener('click', () => saveItem('task'));

        async function saveItem(type) {
            if (!selectedDate || !userId) {
                showCustomAlert('Please select a date first.');
                return;
            }
            
            const item = {
                date: selectedDate.toISOString().split('T')[0],
                time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                timestamp: new Date().toISOString()
            };

            const collections = {
                'appointment': { purpose: 'appointmentPurpose', comments: 'appointmentComments' },
                'event': { purpose: 'eventType', comments: 'eventComments' },
                'task': { purpose: 'taskType', comments: 'taskComments' }
            };

            const purposeEl = document.getElementById(collections[type].purpose);
            const commentsEl = document.getElementById(collections[type].comments);

            if (purposeEl) item.purpose = purposeEl.value;
            if (commentsEl) item.comments = commentsEl.value;

            try {
                const docRef = await addDoc(collection(db, `/artifacts/${__app_id}/users/${userId}/${type}s`), item);
                showCustomAlert(`${type} saved successfully!`);
            } catch (e) {
                console.error("Error adding document: ", e);
                showCustomAlert(`Failed to save ${type}. Please try again.`);
            }
            closeModal(`${type}Modal`);
            generateCalendar(currentMonth, currentYear);
        }

        document.getElementById('viewAppointmentsBtn').addEventListener('click', () => showSavedItems('appointments'));
        document.getElementById('viewEventsBtn').addEventListener('click', () => showSavedItems('events'));
        document.getElementById('viewTasksBtn').addEventListener('click', () => showSavedItems('tasks'));
        document.getElementById('closeSavedItemsBtn').addEventListener('click', () => closeModal('savedItemsModal'));
        document.getElementById('closeAppointmentModal').addEventListener('click', () => closeModal('appointmentModal'));
        document.getElementById('closeEventModal').addEventListener('click', () => closeModal('eventModal'));
        document.getElementById('closeTaskModal').addEventListener('click', () => closeModal('taskModal'));
        document.getElementById('closeMainModal').addEventListener('click', () => closeModal('mainModal'));
        document.getElementById('openAppointmentModal').addEventListener('click', () => { closeModal('mainModal'); openModal('appointmentModal'); });
        document.getElementById('openEventModal').addEventListener('click', () => { closeModal('mainModal'); openModal('eventModal'); });
        document.getElementById('openTaskModal').addEventListener('click', () => { closeModal('mainModal'); openModal('taskModal'); });

        function showSavedItems(type) {
            let items = [];
            if (type === 'appointments') {
                items = savedAppointments;
            } else if (type === 'events') {
                items = savedEvents;
            } else if (type === 'tasks') {
                items = savedTasks;
            }
            
            savedItemsList.innerHTML = '';
            
            if (items.length === 0) {
                savedItemsList.innerHTML = `<p class="text-gray-500">No saved ${type} found.</p>`;
            } else {
                items.forEach(item => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'p-4 border rounded-lg shadow-sm mb-4';
                    
                    let content = `
                        <p><strong>Date:</strong> ${item.date}</p>
                        <p><strong>Time:</strong> ${item.time}</p>
                        <p><strong>Purpose:</strong> ${item.purpose || 'N/A'}</p>
                    `;
                    
                    if (item.comments) {
                        content += `<p><strong>Comments:</strong> ${item.comments}</p>`;
                    }
                    
                    itemEl.innerHTML = content;
                    savedItemsList.appendChild(itemEl);
                });
            }
            openModal('savedItemsModal');
        }

        prevMonthBtn.addEventListener('click', () => {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            generateCalendar(currentMonth, currentYear);
        });

        nextMonthBtn.addEventListener('click', () => {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            generateCalendar(currentMonth, currentYear);
        });

        // Initialize the calendar on page load
        generateCalendar(currentMonth, currentYear);
    </script>
</body>

</html>
