<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Calendar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(to right, #097fd9, #d91d09);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .header h1 .red-text {
            color: #d91d09;
        }
        
        .header h2 {
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .target-animated, .bell-animated, .barber-pole-animated, .razor-animated {
            font-size: 2rem;
            position: absolute;
        }

        .target-animated {
            bottom: 10px;
            animation: target-move 4s ease-in-out infinite;
        }

        @keyframes target-move {
            0% {
                transform: translateX(-100px);
                opacity: 0;
            }
            50% {
                transform: translateX(0);
                opacity: 1;
            }
            100% {
                transform: translateX(100px);
                opacity: 0;
            }
        }

        @keyframes bell-ring {
            0% { transform: rotate(0); }
            15% { transform: rotate(15deg); }
            30% { transform: rotate(-15deg); }
            45% { transform: rotate(15deg); }
            60% { transform: rotate(-15deg); }
            75% { transform: rotate(0); }
            100% { transform: rotate(0); }
        }

        @keyframes barber-pole-spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes razor-shave {
            0%, 100% { transform: translateX(0) rotate(-15deg); }
            50% { transform: translateX(-10px) rotate(5deg); }
        }

        @keyframes zoom-in-out {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.5);
            }
        }

        .bell-ring-animation {
            animation: bell-ring 1s ease-in-out;
        }

        .barber-pole-animated {
            left: 20%;
            top: 10px;
            animation: barber-pole-spin 2s linear infinite, zoom-in-out 3s ease-in-out infinite;
        }

        .razor-animated {
            right: 20%;
            top: 10px;
            animation: razor-shave 1s ease-in-out infinite, zoom-in-out 3s ease-in-out infinite;
            transform-origin: 50% 50%;
        }

        .btn-custom {
            background: linear-gradient(to right, #d91d09, #097fd9);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            transition: background 0.3s ease;
        }

        .btn-custom:hover {
            background: linear-gradient(to right, #b81c08, #0762a4);
        }

        .month-nav-btn {
            background: #d91d09;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        .month-nav-btn:hover {
            background-color: #b81c08;
        }

        .lock-btn {
            background: none;
            border: none;
            color: black;
            font-size: 2rem;
            font-weight: bold;
            transition: color 0.3s;
            cursor: pointer;
        }

        .lock-btn:hover {
            color: #d91d09;
        }
        
        /* New custom modal and backdrop styles for robust functionality */
        .custom-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2001; /* Must be higher than backdrop */
            pointer-events: none; /* Initially non-clickable */
        }
        .custom-modal.open {
            pointer-events: auto;
        }
        .custom-modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 2002;
        }
        .custom-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000; /* Must be behind the modal */
        }

        .hidden {
            display: none !important;
        }
        .bg-blue-appointment {
            background-color: #9de3eb;
        }
        .bg-green-task {
            background-color: #47edcc;
        }
        .blocked-day {
            background-color: #ffcccc;
            color: #888;
        }
        .past-day {
            background-color: #e0e0e0;
            color: #a0a0a0;
            cursor: not-allowed;
        }
        .scrollable-content-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 8px;
        }

        .footer {
            background: linear-gradient(to right, #d91d09 60%, #097fd9);
            height: 50px;
            width: 100%;
            position: relative;
        }

        .calendar-container-wrapper {
            position: relative;
            display: flex;
            width: 100%;
            max-width: 1000px;
            margin: 0 auto;
        }

        .calendar-frame {
            position: absolute;
            height: 100%;
            width: 10px;
            background: linear-gradient(to bottom, #d91d09, #097fd9);
        }

        .calendar-frame-left {
            left: 0;
        }

        .calendar-frame-right {
            right: 0;
        }
        .appointment-completed {
            background-color: #a8f0a8;
        }
    </style>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, setDoc, deleteDoc, getDoc, getDocs, query, where, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('debug');

        // Directly include firebaseConfig
        const firebaseConfig = {
            apiKey: "AIzaSyB0b-ojel3D_gsVg7dqv44BD0rVpacHhW0",
            authDomain: "express-capital-webhook.firebaseapp.com",
            projectId: "express-capital-webhook",
            storageBucket: "express-capital-webhook.firebasestorage.app",
            messagingSenderId: "163338622500",
            appId: "1:163338622500:web:f62cd0a2379ff45e03aab1",
            measurementId: "G-RF71N8KHB7"
        };
        
        // Default app ID for Firestore paths if not provided externally
        const __app_id = 'express-capital-webhook'; 
        const __initial_auth_token = undefined; // No initial auth token for this setup

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userId = null;
        let isAuthReady = false;

        const calendarEl = document.getElementById('calendar');
        const currentMonthYearEl = document.getElementById('currentMonthYear');
        const prevMonthBtn = document.getElementById('prevMonth');
        const nextMonthBtn = document.getElementById('nextMonth');
        const appointmentModal = document.getElementById('appointmentModal');
        const eventModal = document.getElementById('eventModal');
        const taskModal = document.getElementById('taskModal');
        const savedItemsModal = document.getElementById('savedItemsModal');
        const appointmentPurposeEl = document.getElementById('appointmentPurpose');
        const eventTypeEl = document.getElementById('eventType');
        const otherEventContainer = document.getElementById('otherEventContainer');
        const otherTaskContainer = document.getElementById('otherTaskContainer');
        const taskTypeEl = document.getElementById('taskType');
        const eventTimeEl = document.getElementById('eventTime');
        const eventCommentsEl = document.getElementById('eventComments');
        const savedItemsList = document.getElementById('savedItemsList');
        const viewAppointmentsBtn = document.getElementById('viewAppointmentsBtn');
        const viewEventsBtn = document.getElementById('viewEventsBtn');
        const blockBtn = document.getElementById('blockBtn');
        const unblockBtn = document.getElementById('unblockBtn');
        const blockModal = document.getElementById('blockModal');
        const unblockModal = document.getElementById('unblockModal');
        const blockDateSelector = document.getElementById('blockDateSelector');
        const blockFullDayBtn = document.getElementById('blockFullDayBtn');
        const blockStartTimeEl = document.getElementById('blockStartTime');
        const blockEndTimeEl = document.getElementById('blockEndTime');
        const saveBlockBtn = document.getElementById('saveBlockBtn');
        const unblockDateSelector = document.getElementById('unblockDateSelector');
        const showBlockedTimesBtn = document.getElementById('showBlockedTimesBtn');
        const unblockTimesList = document.getElementById('unblockTimesList');
        const bellEmojiEl = document.getElementById('bell-emoji');
        const adminLoginBtn = document.getElementById('adminLoginBtn');
        const exitAdminBtn = document.getElementById('exitAdminBtn');
        const adminButtons = document.querySelectorAll('.admin-button');
        const customAlertModal = document.getElementById('customAlertModal');
        const customAlertMessage = document.getElementById('customAlertMessage');
        const customAlertCloseBtn = document.getElementById('customAlertCloseBtn');

        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let selectedDate = null;
        let savedEvents = [];
        let savedTasks = [];
        let blockedTimes = [];
        let savedAppointments = [];
        let notifiedTasks = {};
        
        // Function to show a custom alert modal
        function showCustomAlert(message) {
            customAlertMessage.textContent = message;
            openModal('customAlertModal');
        }

        // Function to show a custom confirmation modal
        function showCustomConfirm(message, onConfirm) {
            document.getElementById('customConfirmMessage').textContent = message;
            document.getElementById('customConfirmConfirmBtn').onclick = () => {
                onConfirm();
                closeModal('customConfirmModal');
            };
            openModal('customConfirmModal');
        }

        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                const backdrop = document.createElement('div');
                backdrop.className = 'custom-backdrop';
                backdrop.id = 'modalBackdrop';
                document.body.appendChild(backdrop);
                modal.classList.remove('hidden');
                modal.classList.add('open');
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            const backdrop = document.getElementById('modalBackdrop');
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('open');
            }
            if (backdrop) {
                backdrop.remove();
            }
        }

        // New event listeners to handle closing modals when the backdrop is clicked
        document.addEventListener('click', function(e) {
            if (e.target.id === 'modalBackdrop') {
                const openModals = document.querySelectorAll('.custom-modal.open');
                openModals.forEach(modal => {
                    closeModal(modal.id);
                });
            }
        });

        // Event listener for the custom alert close button
        if (customAlertCloseBtn) {
            customAlertCloseBtn.addEventListener('click', () => closeModal('customAlertModal'));
        }
        
        // Event listener for the custom confirm close button
        if (document.getElementById('customConfirmCancelBtn')) {
            document.getElementById('customConfirmCancelBtn').addEventListener('click', () => closeModal('customConfirmModal'));
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
            } else {
                userId = crypto.randomUUID(); // Fallback for anonymous user
            }
            isAuthReady = true;
            document.getElementById('userIdDisplay').textContent = `User ID: ${userId}`;
            
            // Set up real-time listeners for all collections
            onSnapshot(collection(db, `/artifacts/${__app_id}/users/${userId}/appointments`), (snapshot) => {
                savedAppointments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                generateCalendar(currentMonth, currentYear);
            });

            onSnapshot(collection(db, `/artifacts/${__app_id}/users/${userId}/events`), (snapshot) => {
                savedEvents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                generateCalendar(currentMonth, currentYear);
            });

            onSnapshot(collection(db, `/artifacts/${__app_id}/users/${userId}/tasks`), (snapshot) => {
                savedTasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                generateCalendar(currentMonth, currentYear);
            });

            onSnapshot(collection(db, `/artifacts/${__app_id}/users/${userId}/blocked_times`), (snapshot) => {
                blockedTimes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                generateCalendar(currentMonth, currentYear);
            });
            
            // Ensure calendar is generated once auth is ready and listeners are set
            generateCalendar(currentMonth, currentYear);
        });

        if (__initial_auth_token) {
            signInWithCustomToken(auth, __initial_auth_token).catch((error) => {
                console.error("Custom token sign-in failed. Signing in anonymously...", error);
                signInAnonymously(auth);
            });
        } else {
            signInAnonymously(auth);
        }

        adminLoginBtn.addEventListener('click', () => {
            const password = prompt("Please enter the password to unlock admin features. Type 'forget' to reset.");
            if (password === 'admin123') {
                adminButtons.forEach(btn => btn.classList.remove('hidden'));
                exitAdminBtn.classList.remove('hidden');
                adminLoginBtn.classList.add('hidden');
            } else if (password === 'forget') {
                const newPassword = prompt("Please enter a new password:");
                if (newPassword) {
                    showCustomAlert('Password cannot be changed in this version.');
                }
            } else if (password !== null) {
                showCustomAlert('Incorrect password.');
            }
        });
        
        exitAdminBtn.addEventListener('click', () => {
            adminButtons.forEach(btn => btn.classList.add('hidden'));
            exitAdminBtn.classList.add('hidden');
            adminLoginBtn.classList.remove('hidden');
        });

        function generateCalendar(month, year) {
            calendarEl.innerHTML = `
                <div class="text-gray-500">Sun</div>
                <div class="text-gray-500">Mon</div>
                <div class="text-gray-500">Tue</div>
                <div class="text-gray-500">Wed</div>
                <div class="text-gray-500">Thu</div>
                <div class="text-gray-500">Fri</div>
                <div class="text-gray-500">Sat</div>
            `;
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();
            const isCurrentMonth = today.getFullYear() === year && today.getMonth() === month;

            currentMonthYearEl.textContent = new Date(year, month).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            for (let i = 0; i < firstDay; i++) {
                const emptyCell = document.createElement('div');
                calendarEl.appendChild(emptyCell);
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.className = `p-2 rounded-lg cursor-pointer hover:bg-blue-100 transition-colors duration-200`;
                dayCell.textContent = day;

                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                if (isCurrentMonth && day < today.getDate()) {
                    dayCell.classList.add('past-day');
                    dayCell.classList.remove('cursor-pointer', 'hover:bg-blue-100');
                }

                const isBlocked = blockedTimes.some(b => b.date === dateStr && b.time === 'full-day');
                
                if (isBlocked) {
                    dayCell.classList.add('blocked-day');
                    dayCell.classList.remove('cursor-pointer', 'hover:bg-blue-100');
                    dayCell.title = "This day is blocked";
                }
                
                const hasAppointment = savedAppointments.some(appt => appt.date === dateStr);
                if (hasAppointment) {
                    dayCell.classList.add('bg-blue-appointment');
                    dayCell.title = 'Has a saved appointment';
                }

                const hasEvent = savedEvents.some(event => event.date === dateStr);
                if (hasEvent) {
                    dayCell.classList.add('bg-green-task');
                    dayCell.title = 'Has a saved event';
                }

                const hasTask = savedTasks.some(task => task.date === dateStr);
                if (hasTask) {
                    dayCell.classList.add('bg-green-task');
                    dayCell.title = 'Has a saved task';
                }

                dayCell.addEventListener('click', () => {
                    if (dayCell.classList.contains('past-day') || isBlocked) return;
                    selectedDate = dateStr;
                    const isAdmin = !adminLoginBtn.classList.contains('hidden');
                    if (isAdmin) {
                        openModal('appointmentModal');
                        generateTimeOptions(document.getElementById('appointmentTime'), 9, 21, selectedDate);
                    } else {
                        openModal('eventModal');
                        generateTimeOptions(eventTimeEl, 9, 21, selectedDate);
                    }
                });

                calendarEl.appendChild(dayCell);
            }
        }

        function generateTimeOptions(selectElement, startHour, endHour, date) {
            selectElement.innerHTML = '';
            const today = new Date();
            const selectedDateObj = new Date(date);
            const isToday = today.getDate() === selectedDateObj.getDate() && today.getMonth() === selectedDateObj.getMonth() && today.getFullYear() === selectedDateObj.getFullYear();
            const currentHour = today.getHours();
            
            for (let hour = startHour; hour <= endHour; hour++) {
                if (isToday && hour <= currentHour) {
                    continue;
                }
                const formattedHour = String(hour).padStart(2, '0');
                const timeValue = `${formattedHour}:00`;
                
                const isBlocked = blockedTimes.some(block => {
                    if (block.date !== date) return false;
                    if (block.time === 'full-day') return true;
                    if (block.startTime && block.endTime) {
                        const start = parseInt(block.startTime.split(':')[0]);
                        const end = parseInt(block.endTime.split(':')[0]);
                        return hour >= start && hour < end;
                    }
                    return false;
                });
                
                if (!isBlocked) {
                    const option = document.createElement('option');
                    option.value = timeValue;
                    option.textContent = `${hour > 12 ? hour - 12 : hour}:00 ${hour >= 12 ? 'PM' : 'AM'}`;
                    selectElement.appendChild(option);
                }
            }
        }
        
        function showSavedItems(items, title) {
            document.getElementById('savedItemsTitle').textContent = `Saved ${title}`;
            savedItemsList.innerHTML = '';
            if (items.length === 0) {
                savedItemsList.innerHTML = '<p class="text-center text-gray-500">No saved items.</p>';
            } else {
                items.forEach(item => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'bg-gray-100 p-3 rounded-md flex justify-between items-center';
                    let displayText = '';
                    if (title === 'Appointments') {
                        displayText = `${item.date} @ ${item.time}: ${item.name} (${item.phone}) - ${item.purpose}` + (item.comments ? ` Comments: ${item.comments}` : '');
                    } else if (title === 'Events') {
                        displayText = `${item.date} @ ${item.time}: ${item.type}` + (item.details ? ` (${item.details})` : '') + (item.comments ? ` - Comments: ${item.comments}` : '');
                    } else if (title === 'Tasks') {
                        displayText = `${item.date}: ${item.taskType}` + (item.details ? ` (${item.details})` : '');
                    }
                    
                    itemEl.innerHTML = `<span class="flex-1">${displayText}</span>`;

                    const actionsEl = document.createElement('div');

                    const editBtn = document.createElement('button');
                    editBtn.className = 'text-blue-500 hover:text-blue-700 mr-2';
                    editBtn.innerHTML = 'âœï¸';
                    editBtn.onclick = () => editItem(item.id, title.toLowerCase().slice(0, -1));
                    actionsEl.appendChild(editBtn);

                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'text-red-500 hover:text-red-700';
                    deleteBtn.innerHTML = 'ðŸ—‘ï¸';
                    deleteBtn.onclick = () => showCustomConfirm('Are you sure you want to delete this item?', () => deleteItem(item.id, title.toLowerCase().slice(0, -1)));
                    actionsEl.appendChild(deleteBtn);

                    itemEl.appendChild(actionsEl);
                    savedItemsList.appendChild(itemEl);
                });
            }
            openModal('savedItemsModal');
        }

        document.getElementById('closeAppointmentModal').addEventListener('click', () => closeModal('appointmentModal'));
        document.getElementById('closeEventModal').addEventListener('click', () => closeModal('eventModal'));
        document.getElementById('closeTaskModal').addEventListener('click', () => closeModal('taskModal'));
        document.getElementById('closeSavedItemsModal').addEventListener('click', () => closeModal('savedItemsModal'));
        document.getElementById('closeBlockModal').addEventListener('click', () => closeModal('blockModal'));
        document.getElementById('closeUnblockModal').addEventListener('click', () => closeModal('unblockModal'));

        eventTypeEl.addEventListener('change', (e) => {
            otherEventContainer.classList.toggle('hidden', e.target.value !== 'other');
        });

        function resetAppointmentForm() {
            document.getElementById('appointmentTime').value = '';
            document.getElementById('appointmentName').value = '';
            document.getElementById('appointmentPhone').value = '';
            document.getElementById('appointmentPurpose').value = 'regularhaircut';
            document.getElementById('appointmentComments').value = '';
            document.getElementById('submitAppointmentBtn').dataset.editId = ''; // Clear edit ID
        }

        function resetEventForm() {
            document.getElementById('eventType').value = 'doctor';
            document.getElementById('eventTime').value = '';
            document.getElementById('otherEvent').value = '';
            document.getElementById('otherEventContainer').classList.add('hidden');
            document.getElementById('eventComments').value = '';
            document.getElementById('saveEventBtn').dataset.editId = ''; // Clear edit ID
        }

        function resetBlockForm() {
            document.getElementById('blockDateSelector').value = '';
            document.getElementById('blockStartTime').value = '';
            document.getElementById('blockEndTime').value = '';
            // No edit ID for block form as it creates new blocks, not edits existing ones directly from the form
        }

        document.getElementById('submitAppointmentBtn').addEventListener('click', async () => {
            const editId = document.getElementById('submitAppointmentBtn').dataset.editId;
            const appointmentTime = document.getElementById('appointmentTime').value;
            const name = document.getElementById('appointmentName').value.trim();
            const phone = document.getElementById('appointmentPhone').value.trim();
            const purpose = document.getElementById('appointmentPurpose').value;
            const comments = document.getElementById('appointmentComments').value.trim();

            if (!name || !phone) {
                return showCustomAlert('Please enter your name and phone number.');
            }

            if (!selectedDate) {
                return showCustomAlert('Please select a date on the calendar first.');
            }

            try {
                if (editId) {
                    await setDoc(doc(db, `/artifacts/${__app_id}/users/${userId}/appointments`, editId), {
                        date: selectedDate,
                        time: appointmentTime,
                        name: name,
                        phone: phone,
                        purpose: purpose,
                        comments: comments
                    }, { merge: true });
                    showCustomAlert('Appointment successfully updated!');
                    showSavedItems(savedAppointments, 'Appointments');
                } else {
                    await addDoc(collection(db, `/artifacts/${__app_id}/users/${userId}/appointments`), {
                        date: selectedDate,
                        time: appointmentTime,
                        name: name,
                        phone: phone,
                        purpose: purpose,
                        comments: comments
                    });
                    showCustomAlert('Appointment submitted!');
                }
                closeModal('appointmentModal');
                resetAppointmentForm();
            } catch (error) {
                console.error("Error submitting appointment:", error);
                showCustomAlert("Failed to submit appointment. Please try again.");
            }
        });

        document.getElementById('saveEventBtn').addEventListener('click', async () => {
            const editId = document.getElementById('saveEventBtn').dataset.editId;
            const eventType = eventTypeEl.value;
            const eventTime = eventTimeEl.value;
            const details = eventType === 'other' ? document.getElementById('otherEvent').value.trim() : '';
            const comments = eventCommentsEl.value.trim();

            if (eventType === 'other' && !details) {
                return showCustomAlert('Please describe the event.');
            }

            if (!selectedDate) {
                return showCustomAlert('Please select a date on the calendar first.');
            }
            
            try {
                if (editId) {
                    await setDoc(doc(db, `/artifacts/${__app_id}/users/${userId}/events`, editId), {
                        date: selectedDate,
                        time: eventTime,
                        type: eventType,
                        details: details,
                        comments: comments
                    }, { merge: true });
                    showCustomAlert('Event successfully updated!');
                    showSavedItems(savedEvents, 'Events');
                } else {
                    await addDoc(collection(db, `/artifacts/${__app_id}/users/${userId}/events`), {
                        date: selectedDate,
                        time: eventTime,
                        type: eventType,
                        details: details,
                        comments: comments
                    });
                    showCustomAlert('Event saved!');
                }
                closeModal('eventModal');
                resetEventForm();
            } catch (error) {
                console.error("Error saving event:", error);
                showCustomAlert("Failed to save event. Please try again.");
            }
        });

        prevMonthBtn.addEventListener('click', () => {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            generateCalendar(currentMonth, currentYear);
        });

        nextMonthBtn.addEventListener('click', () => {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            generateCalendar(currentMonth, currentYear);
        });

        viewAppointmentsBtn.addEventListener('click', () => {
            showSavedItems(savedAppointments, 'Appointments');
        });

        viewEventsBtn.addEventListener('click', () => {
            showSavedItems(savedEvents, 'Events');
        });

        blockBtn.addEventListener('click', () => {
            openModal('blockModal');
            // Ensure date selector for block is reset
            document.getElementById('blockDateSelector').value = '';
            generateTimeOptions(blockStartTimeEl, 9, 21);
            generateTimeOptions(blockEndTimeEl, 9, 21);
        });

        unblockBtn.addEventListener('click', () => {
            openModal('unblockModal');
            unblockDateSelector.value = '';
            unblockTimesList.innerHTML = '<p class="text-center text-gray-500">Select a date to see blocked times.</p>';
        });

        showBlockedTimesBtn.addEventListener('click', async () => {
            const date = unblockDateSelector.value;
            if (!date) {
                unblockTimesList.innerHTML = '<p class="text-center text-red-500">Please select a date.</p>';
                return;
            }
            
            const blockedTimesForDate = blockedTimes.filter(b => b.date === date);
            unblockTimesList.innerHTML = '';
            if (blockedTimesForDate.length === 0) {
                unblockTimesList.innerHTML = '<p class="text-center text-gray-500">No blocked times for this date.</p>';
            } else {
                blockedTimesForDate.forEach(block => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'bg-gray-100 p-3 rounded-md flex justify-between items-center';
                    let displayText = '';
                    if (block.time === 'full-day') {
                        displayText = 'Full Day';
                    } else {
                        displayText = `${block.startTime} to ${block.endTime}`;
                    }
                    
                    itemEl.innerHTML = `<span class="flex-1">${displayText}</span>`;
                    const unblockButton = document.createElement('button');
                    unblockButton.className = 'text-red-500 hover:text-red-700';
                    unblockButton.innerHTML = 'ðŸ—‘ï¸';
                    unblockButton.onclick = () => showCustomConfirm('Are you sure you want to unblock this time?', () => deleteBlockedTime(block.id));
                    itemEl.appendChild(unblockButton);
                    unblockTimesList.appendChild(itemEl);
                });
            }
        });

        blockFullDayBtn.addEventListener('click', async () => {
            const date = blockDateSelector.value;
            if (!date) return showCustomAlert('Please select a date.');
            
            try {
                await addDoc(collection(db, `/artifacts/${__app_id}/users/${userId}/blocked_times`), {
                    date: date,
                    time: 'full-day'
                });
                showCustomAlert('Full day blocked successfully!');
                closeModal('blockModal');
                resetBlockForm();
            } catch (error) {
                console.error("Error blocking full day:", error);
                showCustomAlert("Failed to block day. Please try again.");
            }
        });

        document.getElementById('saveBlockBtn').addEventListener('click', async () => {
            const date = blockDateSelector.value;
            const startTime = blockStartTimeEl.value;
            const endTime = blockEndTimeEl.value;

            if (!date || !startTime || !endTime) {
                return showCustomAlert('Please select a date, start time, and end time.');
            }

            try {
                await addDoc(collection(db, `/artifacts/${__app_id}/users/${userId}/blocked_times`), {
                    date: date,
                    startTime: startTime,
                    endTime: endTime
                });
                showCustomAlert('Time blocked successfully!');
                closeModal('blockModal');
                resetBlockForm();
            } catch (error) {
                console.error("Error blocking time:", error);
                showCustomAlert("Failed to block time. Please try again.");
            }
        });

        async function deleteBlockedTime(id) {
            try {
                await deleteDoc(doc(db, `/artifacts/${__app_id}/users/${userId}/blocked_times`, id));
                showCustomAlert('Blocked time removed.');
                // Re-fetch blocked times for the unblock modal display
                const date = unblockDateSelector.value;
                if (date) {
                    const blockedTimesForDate = blockedTimes.filter(b => b.date === date);
                    unblockTimesList.innerHTML = ''; // Clear current list
                    if (blockedTimesForDate.length === 0) {
                        unblockTimesList.innerHTML = '<p class="text-center text-gray-500">No blocked times for this date.</p>';
                    } else {
                        blockedTimesForDate.forEach(block => {
                            const itemEl = document.createElement('div');
                            itemEl.className = 'bg-gray-100 p-3 rounded-md flex justify-between items-center';
                            let displayText = '';
                            if (block.time === 'full-day') {
                                displayText = 'Full Day';
                            } else {
                                displayText = `${block.startTime} to ${block.endTime}`;
                            }
                            itemEl.innerHTML = `<span class="flex-1">${displayText}</span>`;
                            const unblockButton = document.createElement('button');
                            unblockButton.className = 'text-red-500 hover:text-red-700';
                            unblockButton.innerHTML = 'ðŸ—‘ï¸';
                            unblockButton.onclick = () => showCustomConfirm('Are you sure you want to unblock this time?', () => deleteBlockedTime(block.id));
                            itemEl.appendChild(unblockButton);
                            unblockTimesList.appendChild(itemEl);
                        });
                    }
                }
            } catch (error) {
                console.error("Error deleting blocked time:", error);
                showCustomAlert("Failed to remove blocked time. Please try again.");
            }
        }

        window.deleteItem = async function(id, type) {
            try {
                let collectionName;
                if (type === 'event') {
                    collectionName = 'events';
                } else if (type === 'appointment') {
                    collectionName = 'appointments';
                }
                await deleteDoc(doc(db, `/artifacts/${__app_id}/users/${userId}/${collectionName}`, id));
                showCustomAlert('Item deleted successfully!');
                // Re-open saved items to show updated list
                if (type === 'event') {
                    showSavedItems(savedEvents, 'Events');
                } else if (type === 'appointment') {
                    showSavedItems(savedAppointments, 'Appointments');
                }
            } catch (error) {
                console.error("Error deleting item:", error);
                showCustomAlert("Failed to delete item. Please try again.");
            }
        };

        window.editItem = function(id, type) {
            closeModal('savedItemsModal');

            if (type === 'event') {
                const item = savedEvents.find(e => e.id === id);
                if (!item) return;

                selectedDate = item.date;
                openModal('eventModal');
                generateTimeOptions(eventTimeEl, 9, 21, selectedDate);
                
                eventTypeEl.value = item.type;
                if (item.type === 'other') {
                    otherEventContainer.classList.remove('hidden');
                    document.getElementById('otherEvent').value = item.details;
                } else {
                    otherEventContainer.classList.add('hidden');
                }

                eventTimeEl.value = item.time;
                eventCommentsEl.value = item.comments || '';
                document.getElementById('saveEventBtn').dataset.editId = id;

            } else if (type === 'appointment') {
                const item = savedAppointments.find(a => a.id === id);
                if (!item) return;

                selectedDate = item.date;
                openModal('appointmentModal');
                generateTimeOptions(document.getElementById('appointmentTime'), 9, 21, selectedDate);

                document.getElementById('appointmentName').value = item.name;
                document.getElementById('appointmentPhone').value = item.phone;
                document.getElementById('appointmentPurpose').value = item.purpose;
                document.getElementById('appointmentComments').value = item.comments || '';
                document.getElementById('appointmentTime').value = item.time;
                document.getElementById('submitAppointmentBtn').dataset.editId = id;
            }
        };

        function showBellNotification() {
            bellEmojiEl.classList.remove('hidden');
            bellEmojiEl.classList.add('bell-ring-animation');
            setTimeout(() => {
                bellEmojiEl.classList.remove('bell-ring-animation');
                bellEmojiEl.classList.add('hidden');
            }, 3000);
        }

        function checkNotifications() {
            const now = new Date();
            savedTasks.forEach(task => {
                if (!task.date) return;
                const taskDateTimeStr = `${task.date}T${task.time || '00:00'}:00`;
                const taskDate = new Date(taskDateTimeStr);
                
                if (isNaN(taskDate.getTime())) {
                    console.error('Invalid task date:', task);
                    return;
                }

                const timeUntilTask = taskDate.getTime() - now.getTime();
                const hoursUntilTask = timeUntilTask / (1000 * 60 * 60);

                if (hoursUntilTask <= 12 && hoursUntilTask > 11) {
                    const message = `ðŸ”” Reminder: You have a task in 12 hours - ${task.taskType}.`;
                    showCustomAlert(message);
                    showBellNotification();
                }

                if (hoursUntilTask <= 2 && hoursUntilTask > 1) {
                    const message = `ðŸ”” Reminder: You have a task in 2 hours - ${task.taskType}.`;
                    showCustomAlert(message);
                    showBellNotification();
                }
            });
        }

        // Call generateCalendar initially to display the calendar frame
        generateCalendar(currentMonth, currentYear);
        setInterval(checkNotifications, 60000);
        checkNotifications(); // Run once on load
    </script>
</head>
<body class="flex flex-col min-h-screen">
    <div class="header">
        <h1 class="text-4xl font-extrabold mb-2">Personal <span class="red-text">Calendar</span></h1>
        <h2 class="text-xl font-semibold mb-4">Your appointments, events, and tasks in one place.</h2>
        <span id="bell-emoji" class="bell-animated hidden">ðŸ””</span>
        <span class="barber-pole-animated">ðŸ’ˆ</span>
        <span class="razor-animated">ðŸ”ª</span>
    </div>

    <main class="flex-grow container mx-auto p-4 flex flex-col items-center">
        <div class="calendar-container-wrapper">
            <div class="calendar-frame calendar-frame-left"></div>
            <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-4xl mx-auto border border-gray-200">
                <div class="flex justify-between items-center mb-6">
                    <button id="prevMonth" class="month-nav-btn">&lt;</button>
                    <h3 id="currentMonthYear" class="text-3xl font-bold text-gray-800"></h3>
                    <button id="nextMonth" class="month-nav-btn">&gt;</button>
                </div>
                <div id="calendar" class="grid grid-cols-7 gap-2 text-center text-lg font-medium">
                    </div>
                <div class="mt-6 flex flex-wrap justify-center gap-4">
                    <button id="viewAppointmentsBtn" class="btn-custom admin-button hidden">View Appointments</button>
                    <button id="viewEventsBtn" class="btn-custom admin-button hidden">View Events</button>
                    <button id="blockBtn" class="btn-custom admin-button hidden">Block Time</button>
                    <button id="unblockBtn" class="btn-custom admin-button hidden">Unblock Time</button>
                </div>
            </div>
            <div class="calendar-frame calendar-frame-right"></div>
        </div>
    </main>

    <div id="appointmentModal" class="custom-modal hidden">
        <div class="custom-modal-content">
            <h3 class="text-xl font-bold mb-4">Add/Edit Appointment</h3>
            <label for="appointmentTime" class="block text-sm font-medium text-gray-700 mb-1">Time:</label>
            <select id="appointmentTime" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 mb-3 focus:ring-blue-500 focus:border-blue-500"></select>
            
            <label for="appointmentName" class="block text-sm font-medium text-gray-700 mb-1">Name:</label>
            <input type="text" id="appointmentName" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 mb-3" placeholder="Client Name">
            
            <label for="appointmentPhone" class="block text-sm font-medium text-gray-700 mb-1">Phone:</label>
            <input type="tel" id="appointmentPhone" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 mb-3" placeholder="Client Phone">
            
            <label for="appointmentPurpose" class="block text-sm font-medium text-gray-700 mb-1">Purpose:</label>
            <select id="appointmentPurpose" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 mb-3">
                <option value="regularhaircut">Regular Haircut</option>
                <option value="beardtrim">Beard Trim</option>
                <option value="shave">Shave</option>
                <option value="other">Other</option>
            </select>
            
            <label for="appointmentComments" class="block text-sm font-medium text-gray-700 mb-1">Comments:</label>
            <textarea id="appointmentComments" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 mb-4" placeholder="Any special requests or notes"></textarea>
            
            <div class="flex justify-end space-x-2">
                <button id="submitAppointmentBtn" class="btn-custom">Save Appointment</button>
                <button id="closeAppointmentModal" class="btn-custom bg-gray-500 hover:bg-gray-600">Cancel</button>
            </div>
        </div>
    </div>

    <div id="eventModal" class="custom-modal hidden">
        <div class="custom-modal-content">
            <h3 class="text-xl font-bold mb-4">Add/Edit Event</h3>
            
            <label for="eventTime" class="block text-sm font-medium text-gray-700 mb-1">Time:</label>
            <select id="eventTime" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 mb-3 focus:ring-blue-500 focus:border-blue-500"></select>

            <label for="eventType" class="block text-sm font-medium text-gray-700 mb-1">Event Type:</label>
            <select id="eventType" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 mb-3">
                <option value="doctor">Doctor Appointment</option>
                <option value="meeting">Meeting</option>
                <option value="birthday">Birthday</option>
                <option value="personal">Personal Event</option>
                <option value="other">Other</option>
            </select>
            
            <div id="otherEventContainer" class="hidden mb-3">
                <label for="otherEvent" class="block text-sm font-medium text-gray-700 mb-1">Describe Event:</label>
                <input type="text" id="otherEvent" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" placeholder="e.g., Dentist, Family Reunion">
            </div>

            <label for="eventComments" class="block text-sm font-medium text-gray-700 mb-1">Comments:</label>
            <textarea id="eventComments" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 mb-4" placeholder="Any additional notes"></textarea>
            
            <div class="flex justify-end space-x-2">
                <button id="saveEventBtn" class="btn-custom">Save Event</button>
                <button id="closeEventModal" class="btn-custom bg-gray-500 hover:bg-gray-600">Cancel</button>
            </div>
        </div>
    </div>

    <div id="taskModal" class="custom-modal hidden">
        <div class="custom-modal-content">
            <h3 class="text-xl font-bold mb-4">Add/Edit Task</h3>
            <label for="taskType" class="block text-sm font-medium text-gray-700 mb-1">Task Type:</label>
            <select id="taskType" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 mb-3">
                <option value="work">Work</option>
                <option value="personal">Personal</option>
                <option value="shopping">Shopping</option>
                <option value="other">Other</option>
            </select>
            <div id="otherTaskContainer" class="hidden mb-3">
                <label for="otherTask" class="block text-sm font-medium text-gray-700 mb-1">Describe Task:</label>
                <input type="text" id="otherTask" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" placeholder="e.g., Pay bills, Buy groceries">
            </div>
            <button id="saveTaskBtn" class="btn-custom">Save Task</button>
            <button id="closeTaskModal" class="btn-custom bg-gray-500 hover:bg-gray-600">Cancel</button>
        </div>
    </div>

    <div id="savedItemsModal" class="custom-modal hidden">
        <div class="custom-modal-content">
            <h3 id="saved
